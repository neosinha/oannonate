<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: mqtt.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: mqtt.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>
	/**
	 * @method 
	 * @memberof SDomusComm
	 */
	function getEpoch() {
		var d = new Date();
		now = d.getTime(); 
		return now; 
	}; 
	

	function mqttConnect () {
		console.log("MQTT Server connection attempt");
	
		//Connect to the client
		mqclient.connect( {
						timeout : 10,
						cleanSession: true,
						useSSL: false, 
						onSuccess:onConnect, 
						onFailure: onFailure, 
						userName: 'sdomus', 
						password: 'Patna'
					});
	
	}; 

	/**
	 * @method
	 * @memberof SDomusComm
	 */
	function onConnect() {
		console.log('MQTT Server connection established.');
		var uqid = new Set();
		//subscribe
		for (i in deviceState) {
			dev = deviceState[i]; 
			mqttch = dev['mqtt'][0]; 
			uqid.add(mqttch);
		}
		arr = Array.from(uqid);
		console.log('==>'+uqid + "==="+ arr.toString());
		for (x in arr) {
			mqttch = arr[x];
			console.log('Subscribing to Device:'+x+ ': '+ mqttch);
			mqclient.subscribe("device/status/"+mqttch);
		}
		
	}; 

	/**
	 * @method
	 * @memberof SDomusComm
	 */
	function onFailure (errorCode) {
		console.log('MQTT Server connection lost.');
		//alert('Connection Lost: '+ errorCode);
	
		//makeDevicesOffline();
		//updateButtonStatus();
		//setTimeout(mqttConnect, reconnectTimeout);
	}; 



	/**
	 * @method
	 * @memberof SDomusComm
	 */
	function onConnectionLost (responseObject) {
		if (responseObject.errorCode !== 0) {
			console.log("onConnectionLost:"+responseObject.errorMessage);
			//makeDevicesOffline();
			updateDevicesUI();
	
			//Connect to the client
			setTimeout(mqttConnect, 2*reconnectTimeout);
		}
	}; 


	/**
	 * 
	 * Called when a message arrives
	 * @method
	 * @memberof SDomusComm
	 */
	function onMessageArrived (message) {
		var d = new Date();
		lastmsg = d.getTime(); 

		//console.log("onMessageArrived:"+message.destinationName +"==>"+message.payloadString);
		topic = message.destinationName.split('/');
		mqttid = topic[topic.length -1];
		//console.log('MQTTID: '+ mqttid);
		payloads = JSON.parse(message.payloadString); 
		keys = Object.keys(payloads);
		for ( key in keys) {
			objkey = keys[key];
			//console.log("--->"+ key + ":" + keys[key] + "=="+ payloads[objkey]);
			//console.log("mQtt: "+ mqttid + ", Sensor: "+ objkey);
			devx = getDeviceByMqttAndSensor(mqttid, objkey);
			//console.log(JSON.stringify(devx) );
			if (devx) {
					devx['lastmsg'] = getEpoch();
					devx['state'] = payloads[objkey]; 
				}
			//console.log(JSON.stringify(devx) );
			}
		updateDevicesUI(); 

	}; 
	
reconnectTimeout = 2000;
mqclient = new Paho.MQTT.Client("home.sinhallc.com", Number(9001), "", "sdc"+ this.getEpoch());
mqclient.startTrace();
mqclient.onConnectionLost = onConnectionLost;
mqclient.onMessageArrived = onMessageArrived; 




</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AuthHandler.html">AuthHandler</a></li><li><a href="deviceModel.html">deviceModel</a></li><li><a href="Framework7UI.html">Framework7UI</a></li><li><a href="Paho.MQTT.Client.html">Client</a></li><li><a href="Paho.MQTT.Message.html">Message</a></li><li><a href="SDomus.html">SDomus</a></li></ul><h3>Namespaces</h3><ul><li><a href="Paho.MQTT.html">MQTT</a></li></ul><h3>Global</h3><ul><li><a href="global.html#auth">auth</a></li><li><a href="global.html#authProceed">authProceed</a></li><li><a href="global.html#devicelist">devicelist</a></li><li><a href="global.html#getUserModel">getUserModel</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.4</a> on Mon Aug 28 2017 20:45:58 GMT-0700 (PDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
